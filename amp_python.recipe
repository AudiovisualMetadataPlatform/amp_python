Bootstrap: docker
From: rockylinux:9.3

%files


%post
dnf install -y dnf-plugins-core
dnf config-manager --setopt install_weak_deps=False --save
cat /etc/dnf/dnf.conf
dnf config-manager -v --set-enabled crb
dnf install -y https://dl.fedoraproject.org/pub/epel/epel-release-latest-9.noarch.rpm

dnf update -y --exclude=filesystem

# install general packages
dnf install -y awscli2 ffmpeg-free ffmpeg-free-devel jq ImageMagick \
  sox gnuplot tesseract

# install pre-build python packages
dnf install -y \
    python3.12 \
    python3-azure-* \
    python3-boto* \
    python3-google-* python3-googleapis-* \
    python3-jira python3-json* \
    python3-ldap* \
    python3-markdown python3-matplotlib \
    python3.12-numpy \
    python3-oauth* python3-opencv \
    python3-pillow python3-protobuf python3-psutil \
    python3.12-pip     \
    python3-pydantic python3-pygraphviz \
    python3-PyMySQL python3.12-pyyaml \
    python3.12-requests \
    python3-s3transfer python3.12-scipy python3-semver python3-sqlalchemy \
    python3.12-tkinter python3-toml \
    python3.12-urllib3

# install development tools
dnf install -y cmake g++ gcc python3.12-devel make

# install more python packages
pip3.12 install \
    exif \
    face-recognition ffmpeg-python filetype \
    gmqtt \
    jiwer \
    Levenshtein \
    num2words \
    pytesseract py-trello \
    scenedetect spacy ssh-python \
    textdistance 
    

python3.12 -m spacy download en_core_web_lg

#dnf remove -y cmake g++ gcc make pipewire texlive proj-*

dnf clean all

%runscript
# Galaxy removes PYTHONPATH at startup because it interferes
# with the normal workings of galaxy.  That's kind of a pain
# because we want to pass that to the tools so they don't have
# to look hard for the amp libraries.
#
# So...let's add it here, based on AMP_ROOT which /doesn't/
# get filtered by galaxy.

if [ -n "$AMP_ROOT" ]; then
    PYROOT=$AMP_ROOT/amp_bootstrap
    if [ -n "$PYTHONPATH" ]; then
        export PYTHONPATH=$PYROOT:$PYTHONPATH
    else
        export PYTHONPATH=$PYROOT
    fi
fi

exec python3.12 "$@"
